{% extends "base.html" %}

{% block content %}
<main class="container my-4">

    <h3 class="text-center mb-4">AI 챗봇</h3>

    <!-- 카드 스타일 채팅 박스 -->
    <div class="card mx-auto" style="max-width: 600px;">
        <div id="chatArea" class="card-body d-flex flex-column gap-2 overflow-auto" style="height: 400px;"></div>
    </div>

    <!-- 입력창 -->
    <form id="chatForm" class="d-flex mt-3 mx-auto" style="max-width:600px;">
        <input id="chatInput" class="form-control me-2" placeholder="메시지를 입력하세요." autocomplete="off">
        <button type="submit" class="btn btn-primary flex-shrink-0">전송</button>
    </form>

</main>

<script>
    function appendMessage(text, type) {
        const area = document.getElementById("chatArea");
        const div = document.createElement("div");

        // 유저/AI 메시지 스타일
        if (type === "user") {
            div.className = "align-self-end badge bg-primary text-white p-2 rounded";
        } else {
            div.className = "align-self-start badge bg-secondary text-white p-2 rounded";
        }

        div.textContent = text;
        area.appendChild(div);
        area.scrollTop = area.scrollHeight;
    }

    async function sendMessage() {
        const input = document.getElementById("chatInput");
        const text = input.value.trim();
        if (!text) return;

        appendMessage(text, "user");
        input.value = "";

        try {
            const res = await fetch("/rnn/predict", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: text })
            });

            const data = await res.json();

            if (data.response) {
                appendMessage(data.response, "ai");
            } else {
                appendMessage("[ERROR] " + (data.error || "응답 실패"), "ai");
            }
        } catch (err) {
            appendMessage("[ERROR] 서버 연결 실패", "ai");
        }
    }

    // 폼 전송
    document.getElementById("chatForm").addEventListener("submit", e => {
        e.preventDefault();
        sendMessage();
    });

    // 엔터키 전송
    document.getElementById("chatInput").addEventListener("keydown", e => {
        if (e.key === "Enter") {
            e.preventDefault();
            sendMessage();
        }
    });
</script>
{% endblock %}